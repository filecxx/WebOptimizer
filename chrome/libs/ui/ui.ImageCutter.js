
Std.ui.module("ImageCutterView",{b:"widget",c:"dragStart dragStop dblclick",e:{level:4,pickerWidth:150,pickerHeight:150,image:null,scale:1,lockerOpacity:.4},protected:{positionX:0,positionY:0,imageData:null},extend:{render:function(){this.initPicker(),this.initDrag()}},n:{initPicker:function(){var t=this,i=t.opts;return Std.dom(t.DOMMap.picker).css({width:i.pickerWidth,height:i.pickerHeight}),t},initDrag:function(){function e(t){var i=a.DOMMap.picker.getContext("2d"),e=t.pageX-s.x-c+r.left,t=t.pageY-s.y-n+r.top;e<0?e=0:e>r.width-o.pickerWidth-2&&(e=r.width-o.pickerWidth-2),t<0?t=0:t>r.height-o.pickerHeight-2&&(t=r.height-o.pickerHeight-2),Std.dom(a.DOMMap.picker).css({top:t,left:e}),i.clearRect(0,0,o.pickerWidth,o.pickerHeight),i.drawImage(a._imageData,-++e,-++t,a._imageData.width*a.scale(),a._imageData.height*a.scale()),a._positionX=e+1,a._positionY=t+1}var a=this,o=a.opts,c=0,n=0,r=null,s=null;return Std.dom(a.DOMMap.picker).mouse({dblclick:function(){a.emit("dblclick")},up:function(t){a.emit("dragStop",t),a[0].off("mousemove",e),a[0].removeStyle("cursor")},down:function(t){var i=Std.dom(a.DOMMap.picker).position();a._imageData&&(s=a[0].offset(),r=Std.dom(a.DOMMap.image).css(["width","height"]),c=t.pageX-s.x-i.x,n=t.pageY-s.y-i.y,r.top=a[0].scrollTop(),r.left=a[0].scrollLeft(),a.emit("dragStart",t),a[0].on("mousemove",e),a[0].css("cursor","move"))}}),a}},j:{lockerOpacity:function(t){return this.opt("lockerOpacity",t,function(){this.DOMMap.locker.opacity(t)})},imageSize:function(){var t=this._imageData;return null===t?t:{width:t.width,height:t.height}},attribute:function(){var t=this,i=t.opts;return{width:i.pickerWidth,height:i.pickerHeight,positionX:t._positionX,positionY:t._positionY}},scale:function(t){var o=this,c=o.opts;return this.opt("scale",t,function(){var t=o._imageData,i=o.DOMMap.image,e=o.DOMMap.picker,a=o.DOMMap.locker;i&&t&&(i.width=t.width*o.scale(),i.height=t.height*o.scale(),i.getContext("2d").drawImage(t,0,0,t.width*o.scale(),t.height*o.scale()),e.width=c.pickerWidth,e.height=c.pickerHeight,e.getContext("2d").drawImage(t,-1,-1,t.width*o.scale(),t.height*o.scale()),a.css({width:t.width*o.scale(),height:t.height*o.scale()}),Std.dom(e).css({left:0,top:0}))})},toBase64:function(){var t=this,i=t.opts,e=t._imageData,a=document.createElement("canvas"),o=a.getContext("2d");return null===e?e:(a.width=i.pickerWidth,a.height=i.pickerHeight,o.drawImage(e,-t._positionX,-t._positionY,e.width*t.scale(),e.height*t.scale()),a.toDataURL())},image:function(t){function e(t){i._imageData=t,i.scale(i.opts.scale)}var i=this;return isObject(t)?e(t):"data:"===t.substr(0,5)?Std.loader.image(t,function(t,i){e(i)}):Std.loader(t,function(t){(t=t.data)&&e(t)}),i}},k:function(t,i,e){t.DOMMap={image:newDom("canvas","_image").dom,locker:newDiv("_locker").css({position:"absolute",left:0,top:0,width:"100%",height:"100%",background:"black"}),picker:newDom("canvas","_picker").css({position:"absolute",left:0,top:0,border:"1px dashed rgba(196,17,17,0.5)"}).dom},e.css({position:"relative",overflow:"auto",background:"white"}).append([t.DOMMap.image,t.DOMMap.locker,t.DOMMap.picker]),t.call_opts("image",!0),t.lockerOpacity(i.lockerOpacity)}}),Std.ui.module("ImageCutter",{b:"widget",c:"submit",e:{level:4,pickerWidth:150,pickerHeight:150,boxSizing:"border-box",image:null,scale:1,lockerOpacity:.4},n:{initEvents:function(){var t=this,i=t.widgets.view;return t.widgets.slider.on("change",function(t){i.scale(t/100)}),t.widgets.OK.on("click",function(){t.emit("submit",[i.toBase64(),i.attribute()],!0)}),t},initSelect:function(){var e=this,a=new Std.dom("input[type='file']",e.widgets.select).css({left:0,top:0,opacity:0,position:"absolute",width:"100%",height:"100%"});return a.on("change",function(){var t,i=a.dom.files;i.length<0||!Std.url.suffix.img(Std.url(i[0].name).suffix)||((t=new FileReader).readAsDataURL(i[0]),t.onload=function(){e._fileSize=i[0].size,e._fileName=i[0].name,e.widgets.view.image(t.result)})}),e},initWidgets:function(){var t=this,i=t.opts;return t.widgets=Std.ui({view:{ui:"ImageCutterView",scale:i.scale,image:i.image,pickerWidth:i.pickerWidth,pickerHeight:i.pickerHeight,lockerOpacity:i.lockerOpacity},slider:{ui:"HSlider",min:10,max:200,value:100},select:{ui:"Button",text:"select"},OK:{ui:"Button",text:"OK"}}),t}},j:{image:function(t){return this.widgets.view.image(t),this},fileName:function(){return this._fileName},fileSize:function(){return this._fileSize}},k:function(t,i,e){t.initWidgets(),t.initEvents(),t.initSelect(),t.layout({ui:"VBoxLayout",items:[t.widgets.view,{ui:"HBoxLayout",items:[t.widgets.slider,t.widgets.select,t.widgets.OK]}]})}});
"undefined;"